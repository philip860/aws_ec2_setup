    - name: Create a new VPC 

      amazon.aws.ec2_vpc_net:

        name: "Ansible-Test"

        cidr_block: "{{ cidr_block }}"

        aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID')  }}"

        aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY')  }}"

        region: "{{ region }}"

      register: vpc


    - name: Create a new Subnet

      amazon.aws.ec2_vpc_subnet:

        aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID')  }}"

        aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY')  }}"

        cidr: "{{ cidr }}"

        region: "{{ region }}"

        vpc_id: "{{ vpc.vpc.id }}"

      register: subnet
    

    - name: Create a Security Group  

      amazon.aws.ec2_security_group:

        name: "Ansible-Test-Security-Group"

        description: "Ansible-Testing"

        aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID')  }}"

        aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY')  }}"

        vpc_id: "{{ vpc.vpc.id }}"

        region: "{{ region }}"

        rules:

          - proto: tcp

            ports:

            - 80

            cidr_ip: 0.0.0.0/0

            rule_desc: "allow all on port 80"

      register: security_group
   

    - name: Launch an EC2 Instance

      amazon.aws.ec2_instance:

        name: "Test-Ansible"

        key_name: "{{ key_name }}"

        aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID')  }}"

        aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY')  }}"

        vpc_subnet_id: "{{ subnet.subnet.id }}"

        instance_type: "{{ instance_type }}"

        security_group: "{{ security_group.group_id  }}"

        count: 1

        wait: yes

        aws_region: "us-east-1"

        network:

          assign_public_ip: true

        image_id: "{{ ami }}"